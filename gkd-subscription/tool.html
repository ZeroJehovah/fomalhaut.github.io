<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="author" content="IceRovah, icerovah@gmail.com" />

	<title>GKD订阅转换</title>
    <link rel="shortcut icon" type="image/ico" href="icon/favicon.ico" />
    <link rel="bookmark" href="icon/favicon.ico" />

	<style>
		p#message {
			border: 1px solid #ccc;
			width: 400px;
			height: 200px;
			line-height: 200px;
			text-align: center;
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			margin: auto;
		}
	</style>

	<script>
		var gkd_url = "https://registry.npmmirror.com/@gkd-kit/subscription/latest/files";
		var github_url = "https://github.com/ZeroJehovah/zerojehovah.github.io/edit/master/gkd-subscription/gkd.json5";
		var json;

		window.onload = function() {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', gkd_url, true);
			xhr.send();
	
			show_message("正在获取订阅");
			xhr.onreadystatechange = function (e) {
				if (xhr.readyState == 4 && xhr.status == 200) {
					json = xhr.responseText;
					convert();
					show_message("<a href='javascript:copy()'>复制</a>");
				}
			};
		}

		function convert() {
			json = json.replace("id:0,name:'默认订阅'", "id:1,name:'默认订阅转换'");
			var json_pre = json.substr(0, json.lastIndexOf("apps:"));
			var json_app = json.substr(json.lastIndexOf("apps:"));
			json_app = json_app.replaceAll(",enable:false", "");
			json_app = json_app.replaceAll("enable:false,", "");
			json = json_pre + json_app;
			json = json.trim();
			console.log(json);
		}

		function copy() {
			show_message("正在复制");
			if (navigator.clipboard) {
				// clipboard api 复制
				navigator.clipboard.writeText(json);
			} else {
				var textarea = document.createElement('textarea');
				document.body.appendChild(textarea);
				// 隐藏此输入框
				textarea.style.position = 'fixed';
				textarea.style.clip = 'rect(0 0 0 0)';
				textarea.style.top = '10px';
				// 赋值
				textarea.value = json;
				// 选中
				textarea.select();
				// 复制
				document.execCommand('copy', true);
				// 移除输入框
				document.body.removeChild(textarea);
			}
			show_message("<a href='javascript:redirect()'>跳转</a>");
		}

		function redirect() {
			show_message("正在跳转");
			window.open(github_url, "_self");
		}

		function show_message(message) {
			document.getElementById("message").innerHTML = message;
		}
	</script>
</head>
<body>
	<p id="message"></p>
</body>
</html>